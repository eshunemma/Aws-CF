AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template for IAM, S3 access, Secrets Manager, Parameter Store, EventBridge, and Lambda.

Parameters:
  User3Email:
    Type: String
    Description: Email of the first user
  User4Email:
    Type: String
    Description: Email of the second user

Resources:
  S3ReadAccessPolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: S3ReadAccessPolicy
      PolicyDocument: 
        Version: '2012-10-17'
        Statement: 
          - Effect: Allow
            Action: 
              - s3:GetObject
              - s3:ListBucket
            Resource: '*'

  S3Group:
    Type: AWS::IAM::Group
    Properties:
      GroupName: S3ReadOnlyGroup
      Policies:
        - PolicyName: S3ReadOnlyPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: '*'

  EC2Group:
    Type: AWS::IAM::Group
    Properties:
      GroupName: EC2S3ReadOnlyGroup
      Policies:
        - PolicyName: EC2S3ReadOnlyPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: '*'

  SecretForIAMUsers:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: IAMUserPassword
      Description: Temporary password for IAM users.
      GenerateSecretString:
        SecretStringTemplate: '{"password":"tempPassword"}'
        GenerateStringKey: "password"

  IAMUser3:
    Type: AWS::IAM::User
    Properties:
      UserName: User3
      Groups:
        - !Ref S3Group
      LoginProfile:
        Password: !Sub "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
        PasswordResetRequired: true

  IAMUser4:
    Type: AWS::IAM::User
    Properties:
      UserName: User4
      Groups:
        - !Ref EC2Group
      LoginProfile:
        Password: !Sub "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
        PasswordResetRequired: true

  ParameterStoreUser3Email:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /IAM/User3/Email
      Type: String
      Value: !Ref User3Email

  ParameterStoreUser4Email:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /IAM/User4/Email
      Type: String
      Value: !Ref User4Email

  EventBridgeRule:
    Type: AWS::Events::Rule
    Properties:
      Name: IAMUserCreationRule
      EventPattern:
        source:
          - "aws.iam"
        detail-type:
          - "AWS API Call via CloudTrail"
        detail:
          eventName:
            - "CreateUser"
      Targets:
        - Arn: !GetAtt SendUserEmailLambda.Arn
          Id: SendUserEmailLambdaTarget

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - secretsmanager:GetSecretValue
                Resource: '*'

  SendUserEmailLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: SendUserEmailLambda
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        ZipFile: |
          const AWS = require('aws-sdk');
          const ssm = new AWS.SSM();
          const secretsManager = new AWS.SecretsManager();
          
          exports.handler = async (event) => {
              const userName = event.detail.requestParameters.userName;

              const emailParamName = `/IAM/${userName}/Email`;
              const emailParam = await ssm.getParameter({ Name: emailParamName }).promise();
              const email = emailParam.Parameter.Value;
              
              const secretValue = await secretsManager.getSecretValue({ SecretId: 'IAMUserPassword' }).promise();
              const tempPassword = JSON.parse(secretValue.SecretString).password;
              
              console.log(`User: ${userName}, Email: ${email}, Temporary Password: ${tempPassword}`);
          };
      Runtime: nodejs18.x
      Timeout: 30

Outputs:
  User3Login:
    Description: Console login for User3
    Value: !Join 
      - ""
      - - "https://"
        - !Ref "AWS::Region"
        - ".signin.aws.amazon.com/console"

  User4Login:
    Description: Console login for User4
    Value: !Join 
      - ""
      - - "https://"
        - !Ref "AWS::Region"
        - ".signin.aws.amazon.com/console"
