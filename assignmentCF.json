{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation template for IAM, S3 access, Secrets Manager, Parameter Store, EventBridge, and Lambda.",
  "Parameters": {
    "User1Email": {
      "Type": "String",
      "Description": "Email of the first user"
    },
    "User2Email": {
      "Type": "String",
      "Description": "Email of the second user"
    }
  },
  "Resources": {
    "S3Group": {
      "Type": "AWS::IAM::Group",
      "Properties": {
        "GroupName": "S3ReadOnlyGroup",
        "Policies": [
          {
            "PolicyName": "S3ReadOnlyPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["s3:GetObject", "s3:ListBucket"],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "EC2Group": {
      "Type": "AWS::IAM::Group",
      "Properties": {
        "GroupName": "EC2S3ReadOnlyGroup",
        "Policies": [
          {
            "PolicyName": "EC2S3ReadOnlyPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["s3:GetObject", "s3:ListBucket"],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "SecretForIAMUsers": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": "IAMUserPassword",
        "Description": "Temporary password for IAM users.",
        "GenerateSecretString": {
          "SecretStringTemplate": "{\"password\":\"tempPassword\"}",
          "GenerateStringKey": "password"
        }
      }
    },
    "IAMUser1": {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "User1",
        "Groups": [
          {
            "Ref": "S3Group"
          }
        ],
        "LoginProfile": {
          "Password": {
            "Fn::Sub": "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
          },
          "PasswordResetRequired": true
        }
      }
    },
    "IAMUser2": {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "User2",
        "Groups": [
          {
            "Ref": "EC2Group"
          }
        ],
        "LoginProfile": {
          "Password": {
            "Fn::Sub": "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
          },
          "PasswordResetRequired": true
        }
      }
    },
    "ParameterStoreUser1Email": {
      "Type": "AWS::SSM::Parameter",
      "Properties": {
        "Name": "/IAM/User1/Email",
        "Type": "String",
        "Value": {
          "Ref": "User1Email"
        }
      }
    },
    "ParameterStoreUser2Email": {
      "Type": "AWS::SSM::Parameter",
      "Properties": {
        "Name": "/IAM/User2/Email",
        "Type": "String",
        "Value": {
          "Ref": "User2Email"
        }
      }
    }
  },
  "Outputs": {
    "User1Login": {
      "Description": "Console login for User1",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Ref": "AWS::Region"
            },
            ".signin.aws.amazon.com/console"
          ]
        ]
      }
    },
    "User2Login": {
      "Description": "Console login for User2",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Ref": "AWS::Region"
            },
            ".signin.aws.amazon.com/console"
          ]
        ]
      }
    },
    "User1Password": {
      "Description": "Temporary password for User1",
      "Value": {
        "Fn::Join": [
          "",
          [
            "Temp password is stored in Secrets Manager: ",
            {
              "Fn::Sub": "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
            }
          ]
        ]
      }
    },
    "User2Password": {
      "Description": "Temporary password for User2",
      "Value": {
        "Fn::Join": [
          "",
          [
            "Temp password is stored in Secrets Manager: ",
            {
              "Fn::Sub": "{{resolve:secretsmanager:${SecretForIAMUsers}::password}}"
            }
          ]
        ]
      }
    }
  }
}
